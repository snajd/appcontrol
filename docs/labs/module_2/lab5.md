---
title: Lab 5 - LOLBINS/LOLBAS
parent: Module 2
layout: home
nav_order: 5
nav_enabled: true
---


# Lab 5 - Living of the Land Binaries

One cannot talk about a list of known bypasses without giving some more info. 
In the security community, we often talk about "living of the land", which simply means that instead of an threat actor (or red teamer) downloads their own tools to a compromised system, they instead use the built in tools and capabilities in the operating system. This is much harder to detect and doesn't trigger antiviruses. Nowadays with the prevalance of EDR:s, they can still trigger some alarms if they for instance use certutil.exe to download a file from the internet.

A list of known LOLBINS and example on how to use them, for Windows can be found [here](https://lolbas-project.github.io/)

Lolbins are a real hassle for us defenders, because if block them with App Control the operating system would get unusable.
We can use AppLocker and block most of them for Normal user but still allow them for Administrators or other groups of users.

Another smart way is to block lolbins in the local firewall from talking to the internet. And we can actually use App Control for just that. More on that in a later lab.


There is also another related project by the security researcher @bohops: [The Ultimate WDAC Bypass List](https://github.com/bohops/UltimateWDACBypassList)

Bohops have tried to find information on all the stuff Microsoft adds to the Recommended Block list and how you can exploit them.


1. Use WDAC Policy Wizard to create a new policy based on Default Windows Mode (like in the last lab)
2. This time, *do not check* the checkboxes to Merge with Recommended User Mode Block Rules and Merge with Recommended Kernel Block Rules
3. Configure the policy to not be in Audit mode
4. Name the policy "Module 2 Lab 5 - Allow Windows - Enforce" and save it to C:\Policies\Mod2Lab5-AllowWindows-Enforce.xml
5. Deploy the policy by copying the cip-file generated by WDAC Policy Wizard to `C:\windows\system32\CodeIntegrity\CiPolicies\Active` and reboot (or use citool -r och RefreshPolicy(AMD64).exe to refresh the policy)
6. Use `citool -lp` to verify that the policy is applied
7. Open an elevated Terminal and run: `wsl --install` to install Windows Subsystem for Linux

```
PS C:\Users\RobinEngstrÃ¶m> wsl --install
Installing: Virtual Machine Platform
Virtual Machine Platform has been installed.
Installing: Windows Subsystem for Linux
Windows Subsystem for Linux has been installed.
Installing: Ubuntu
Ubuntu has been installed.
The requested operation is successful. Changes will not be effective until the system is rebooted.
```

8. Restart the computer when prompted.

We now have a computer running App Control i Enforce mode that should only allow things that comes bundled with Windows. What do you think will happen if we try to install something inside Windows Subsystem for Linux?

Note: WSL2 requires the computer to have support for virtualization. If you are running on a Virtual Machine in Hyper-V you need to run the following from the host:

`Set-VMProcessor -VMName "LABVMNAME" -ExposeVirtualizationExtensions $true`

9. When rebooted after installing Windows Subsystem for Linux, start Terminal and run `wsl.exe` or `bash.exe`. You should be prompted to create a new username and password

![alt text](/img/mod2-lab5-img1.jpg)

Okey, so now we have started Linux inside our locked down Windows machine. Can we install something from the internet that is definitly not signed by Microsoft or the Windows team?

10. Run the following in the Linux terminal: `sudo apt update; sudo apt install hping3 lolcat -y`
11. When hping3 and lolcat have been installed, test that you can run hping3: `sudo hping3 localhost`

TRIVIA!
Did you know that you can pipe things from a Windows command line and pipe them in to a WSL and get a result back in Windows?

12. Open a new Terminal window and try the following: `get-service | ubuntu run lolcat`. The output from Get-Service will be sent to the lolcat command in ubuntu and stdout from lolcat will be sent back to our Terminal again. Cool, right? And a bit scary of course.

![alt text](/img/mod2-lab5-img2.jpg)


**When completed:**

**Remove the deployed policy from `C:\windows\system32\CodeIntegrity\CiPolicies\Active`.**

**Reboot the virtual machine, log on and use `citool.exe -lp` (or the Event Log) to verify that no custom policies are still applied.**